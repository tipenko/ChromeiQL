
/**
 * This GraphiQL example illustrates how to use some of GraphiQL's props
 * in order to enable reading and updating the URL parameters, making
 * link sharing of queries a little bit easier.
 *
 * This is only one example of this kind of feature, GraphiQL exposes
 * various React params to enable interesting integrations.
 */

// Shortcut for React.createElement...
var rc = _.partial(React.createElement);

// Parse the search string to get url parameters.
var search = window.location.search;
var parameters = {};
search.substr(1).split('&').forEach(function (entry) {
  var eq = entry.indexOf('=');
  if (eq >= 0) {
    parameters[decodeURIComponent(entry.slice(0, eq))] =
      decodeURIComponent(entry.slice(eq + 1));
  }
});

// if variables was provided, try to format it.
if (parameters.variables) {
  try {
    parameters.variables =
      JSON.stringify(JSON.parse(parameters.variables), null, 2);
  } catch (e) {
    // Do nothing, we want to display the invalid JSON as a string, rather
    // than present an error.
  }
}

// When the query and variables string is edited, update the URL bar so
// that it can be easily shared
function onEditQuery(newQuery) {
  parameters.query = newQuery;
  updateURL();
}

function onEditVariables(newVariables) {
  parameters.variables = newVariables;
  updateURL();
}

function updateURL() {
  var newSearch = '?' + Object.keys(parameters).map(function (key) {
    return encodeURIComponent(key) + '=' +
      encodeURIComponent(parameters[key]);
  }).join('&');
  history.replaceState(null, null, newSearch);
}

// Defines a GraphQL fetcher using the fetch API.
function graphQLFetcher(endpoint) {
  return function(graphQLParams) {
    return fetch(endpoint, {
      method: 'post',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(graphQLParams),
      credentials: 'include',
    }).then(function (response) {
      return response.json()
    });
  }
}

var ChromeiQL = React.createClass({
  getInitialState: function() {
    return {
      currentEndpoint: null,
      newEndpoint: this.props.endpoint
    };
  },

  render: function() {
    var graphqlConsole = null;
    var endpoint = this.state.currentEndpoint || this.state.newEndpoint;
    if (endpoint) {
      graphqlConsole = rc(GraphiQL, {
        id: "graphiql",
        fetcher: graphQLFetcher(endpoint),
        query: parameters.query,
        variables: parameters.variables,
        onEditQuery: onEditQuery,
        onEditVariables: onEditVariables
      });
    }

    if (this.state.newEndpoint) {
      setTimeout(this.updateEndpointState, 500);
    }

    return (
      rc('div', {id: "application"},
        rc('div', {id: "url-bar"},
          rc('input', {type: "text", id: "url-box", defaultValue: endpoint, onChange: this.updateEndpoint}),
          rc('button', {id: "url-save-button", onClick: this.setEndpoint}, "Set endpoint")
        ),
        graphqlConsole
      )
    );
  },

  updateEndpointState: function() {
    this.setState({ currentEndpoint: this.state.newEndpoint, newEndpoint: null });
    $('button.execute-button').click();
  },

  setEndpoint: function() {
    var newEndpoint = window.chromeiqlEndpoint;
    var setState = this.setState.bind(this);
    chrome.storage.local.set(
      {"chromeiqlEndpoint": newEndpoint},
      function () {
        if (!chrome.runtime.lastError) {
          setState({ newEndpoint: newEndpoint });
        }
      }
    );
  },

  updateEndpoint: function(e) {
    window.chromeiqlEndpoint = e.target.value;
  }
});

chrome.storage.local.get("chromeiqlEndpoint", function(storage) {
  // Render <GraphiQL /> into the body.
  ReactDOM.render(
    rc(ChromeiQL, { endpoint: storage.chromeiqlEndpoint }),
    document.body
  );
});
